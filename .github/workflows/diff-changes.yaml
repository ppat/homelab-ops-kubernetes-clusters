---
# yamllint disable rule:line-length
name: diff-changes

on:
  pull_request:
    branches: ["main"]
    paths:
    - '.github/workflows/diff-changes.yaml'
    - 'clusters/**/*.yaml'
    - 'policies/**/*.yaml'

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  detect-changes:
    runs-on: ubuntu-24.04
    timeout-minutes: 2
    outputs:
      affected_clusters: ${{ steps.extract-clusters.outputs.clusters }}
    steps:
    - name: Checkout
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
      with:
        fetch-depth: 1

    - name: Get changed cluster directories
      id: changed-dirs
      uses: tj-actions/changed-files@2f7c5bfce28377bc069a65ba478de0a74aa0ca32 # v46
      with:
        files: |
          .github/workflows/diff-changes.yaml
          clusters/**/*.yaml
          policies/**/*.yaml
        dir_names: true
        dir_names_max_depth: 2
        dir_names_exclude_current_dir: true
        matrix: true

    - name: Extract cluster names
      id: extract-clusters
      shell: bash
      # yamllint disable-line rule:indentation
      run: |
        if [[ '${{ steps.changed-dirs.outputs.all_changed_files }}' == '[".github/workflows"]' ]]; then
          echo "Testing all clusters for flux-local version upgrade..."
          echo 'clusters=["homelab","nas"]' >> $GITHUB_OUTPUT
        else
          echo "Testing changed clusters..."
          # Extract cluster names from directory paths like "clusters/homelab" -> "homelab"
          mapfile -t clusters < <(echo '${{ steps.changed-dirs.outputs.all_changed_files }}' | jq -r 'map(select(startswith("clusters/")) | split("/")[1]) | unique | .[]')
          # Convert arrays to JSON using printf and jq
          printf '%s\n' "${clusters[@]}" | jq -R . | jq -s -c . > /tmp/clusters.json
          echo "clusters=$(cat /tmp/clusters.json)" >> $GITHUB_OUTPUT
        fi

  diff:
    runs-on: ubuntu-24.04
    timeout-minutes: 5
    needs: [detect-changes]
    if: ${{ needs.detect-changes.outputs.affected_clusters != '[]' }}
    strategy:
      fail-fast: false
      matrix:
        cluster: ${{ fromJSON(needs.detect-changes.outputs.affected_clusters) }}
        resource: [helmrelease, kustomization]

    steps:
    - name: Checkout modules repository
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
      with:
        fetch-depth: 0
        path: modules
        persist-credentials: false
        repository: ppat/homelab-ops-kubernetes-apps

    - name: Checkout after branch
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
      with:
        path: after
        persist-credentials: false

    - name: Checkout before branch
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
      with:
        path: before
        persist-credentials: false
        ref: "${{ github.event.repository.default_branch }}"

    - name: Prepare external sources [after]
      id: prepare-after-sources
      shell: bash
      working-directory: ./after
      # yamllint disable-line rule:indentation
      run: |
        echo "Detecting all kustomizations..."
        grep -rlPz 'apiVersion: kustomize.toolkit.fluxcd.io/v1\nkind: Kustomization' clusters/${{ matrix.cluster }}/ | xargs -n1 yq '[.metadata.name, .spec.path, .spec.sourceRef.name]' -o csv | sort > /tmp/ks_after
        cat /tmp/ks_after | tr ',' '\n' | column -t | pr -t -o 4
        echo " "

        echo "Preparing external sources..."
        while IFS= read -r ks; do
          ks_name=$(echo ${ks} | cut -d',' -f1)
          ks_path=$(echo ${ks} | cut -d',' -f2)
          ks_src="clusters/${{ matrix.cluster }}/$(echo ${ks} | cut -d',' -f3).yaml"
          if [[ -e "${ks_src}" ]]; then
            ks_src_tag=$(yq '.spec.ref.tag // .spec.ref.branch' "${ks_src}")
            pushd ../modules 2> /dev/null
            git checkout ${ks_src_tag}
            if [[ -e "${ks_path}" ]]; then
              echo "${ks_name}: modules@${ks_src_tag} -> ./after/${ks_path}..."
              mkdir -p "../after/${ks_path}"
              cp -R ${ks_path} ../after/${ks_path}
            fi
            popd 2> /dev/null
          fi
        done < <(cat /tmp/ks_after | grep -v root) | pr -t -o 4
        echo " "

        echo "Transforming into concatenated source list..."
        ext_src_list=$(cat /tmp/ks_after | grep -v root | cut -d',' -f3 | paste -sd ',' -)
        echo "after_sources=${ext_src_list}" >> $GITHUB_OUTPUT
        echo ${ext_src_list} | pr -t -o 4

    - name: Prepare external sources [before]
      id: prepare-before-sources
      shell: bash
      working-directory: ./before
      # yamllint disable-line rule:indentation
      run: |
        echo "Detecting all kustomizations..."
        grep -rlPz 'apiVersion: kustomize.toolkit.fluxcd.io/v1\nkind: Kustomization' clusters/${{ matrix.cluster }}/ | xargs -n1 yq '[.metadata.name, .spec.path, .spec.sourceRef.name]' -o csv | sort > /tmp/ks_before
        cat /tmp/ks_before | tr ',' '\n' | column -t | pr -t -o 4
        echo " "

        echo "Preparing external sources..."
        while IFS= read -r ks; do
          ks_name=$(echo ${ks} | cut -d',' -f1)
          ks_path=$(echo ${ks} | cut -d',' -f2)
          ks_src="clusters/${{ matrix.cluster }}/$(echo ${ks} | cut -d',' -f3).yaml"
          if [[ -e "${ks_src}" ]]; then
            ks_src_tag=$(yq '.spec.ref.tag // .spec.ref.branch' "${ks_src}")
            pushd ../modules 2> /dev/null
            git checkout ${ks_src_tag}
            if [[ -e "${ks_path}" ]]; then
              echo "${ks_name}: modules@${ks_src_tag} -> ./before/${ks_path}..."
              mkdir -p "../before/${ks_path}"
              cp -R ${ks_path} ../before/${ks_path}
            fi
            popd 2> /dev/null
          fi
        done < <(cat /tmp/ks_before | grep -v root) | pr -t -o 4
        echo " "

        echo "Transforming into concatenated source list..."
        ext_src_list=$(cat /tmp/ks_before | grep -v root | cut -d',' -f3 | paste -sd ',' -)
        echo "before_sources=${ext_src_list}" >> $GITHUB_OUTPUT
        echo ${ext_src_list} | pr -t -o 4

    - name: Combine external sources [before + after]
      id: combine-sources
      env:
        AFTER_SOURCES: ${{ steps.prepare-after-sources.outputs.after_sources }}
        BEFORE_SOURCES: ${{ steps.prepare-before-sources.outputs.before_sources }}
      shell: bash
      # yamllint disable-line rule:indentation
      run: |
        echo "Combining sources..."
        echo "${AFTER_SOURCES}" | tr ',' '\n' > /tmp/combined_sources
        echo "${BEFORE_SOURCES}" | tr ',' '\n' >> /tmp/combined_sources
        combined_sources=$(cat /tmp/combined_sources | sort | uniq | paste -sd ',' -)
        echo "combined_sources=${combined_sources}" >> $GITHUB_OUTPUT
        echo ${combined_sources} | pr -t -o 4

    - name: Run flux-local diff
      uses: docker://ghcr.io/allenporter/flux-local:v7.5.4@sha256:72dbdeabca1eb4d1a053c78dfa0d1d8e2a4c4aee2c8d3938db1a382d22b0a6f9
      with:
        args: >-
          diff ${{ matrix.resource }}
          --unified 6
          --path /github/workspace/after/clusters/${{ matrix.cluster }}
          --path-orig /github/workspace/before/clusters/${{ matrix.cluster }}
          --skip-crds
          --skip-secrets
          --strip-attrs "helm.sh/chart,checksum/config,app.kubernetes.io/version,chart"
          --limit-bytes 10000
          --all-namespaces
          --sources "root,${{ steps.combine-sources.outputs.combined_sources }}"
          --output-file diff.patch

    - name: Generate Diff
      id: diff
      run: |
        echo 'diff<<EOF' >> $GITHUB_OUTPUT
        cat diff.patch >> $GITHUB_OUTPUT
        echo 'EOF' >> $GITHUB_OUTPUT

    - name: Add PR comment w/ diff
      uses: mshick/add-pr-comment@b8f338c590a895d50bcbfa6c5859251edc8952fc # v2
      if: ${{ steps.diff.outputs.diff != '' }}
      continue-on-error: true
      with:
        repo-token: ${{ secrets.GITHUB_TOKEN }}
        message-id: "${{ github.event.pull_request.number }}/${{ matrix.cluster }}/${{ matrix.resource }}"
        message-failure: Unable to post ${{ matrix.resource }} diff for ${{ matrix.cluster }}
        message: |
          `````diff
          ${{ steps.diff.outputs.diff }}
          `````
