---
# yamllint disable rule:line-length
name: diff-changes

on:
  pull_request:
    branches: ["main"]
    paths:
    - '.github/workflows/diff-changes.yaml'
    - 'clusters/**/*.yaml'
    - 'policies/**/*.yaml'

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  detect-changes:
    runs-on: ubuntu-24.04
    timeout-minutes: 2
    outputs:
      affected_clusters: ${{ steps.extract-clusters.outputs.clusters }}
    steps:
    - name: Checkout
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
      with:
        fetch-depth: 1

    - name: Get changed cluster directories
      id: changed-dirs
      uses: tj-actions/changed-files@2f7c5bfce28377bc069a65ba478de0a74aa0ca32 # v46
      with:
        files: |
          .github/workflows/diff-changes.yaml
          clusters/**/*.yaml
          policies/**/*.yaml
        dir_names: true
        dir_names_max_depth: 2
        dir_names_exclude_current_dir: true
        matrix: true

    - name: Extract cluster names
      id: extract-clusters
      shell: bash
      # yamllint disable-line rule:indentation
      run: |
        if [[ '${{ steps.changed-dirs.outputs.all_changed_files }}' == '[".github/workflows"]' ]]; then
          echo "Testing all clusters for flux-local version upgrade..."
          echo 'clusters=["homelab","nas"]' >> $GITHUB_OUTPUT
        else
          echo "Testing changed clusters..."
          # Extract cluster names from directory paths like "clusters/homelab" -> "homelab"
          mapfile -t clusters < <(echo '${{ steps.changed-dirs.outputs.all_changed_files }}' | jq -r 'map(select(startswith("clusters/")) | split("/")[1]) | unique | .[]')
          # Convert arrays to JSON using printf and jq
          printf '%s\n' "${clusters[@]}" | jq -R . | jq -s -c . > /tmp/clusters.json
          echo "clusters=$(cat /tmp/clusters.json)" >> $GITHUB_OUTPUT
        fi

  diff:
    runs-on: ubuntu-24.04
    timeout-minutes: 5
    needs: [detect-changes]
    if: ${{ needs.detect-changes.outputs.affected_clusters != '[]' }}
    strategy:
      fail-fast: false
      matrix:
        cluster: ${{ fromJSON(needs.detect-changes.outputs.affected_clusters) }}
        resource: [helmrelease, kustomization]

    steps:
    - name: Setup flux
      uses: fluxcd/flux2/action@bda4c8187e436462be0d072e728b67afa215c593 # v2.6.3
      with:
        # renovate: datasource=github-releases depName=fluxcd/flux2
        version: "v2.6.4"

    - name: Checkout modules repository
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
      with:
        fetch-depth: 1
        path: modules
        persist-credentials: false
        repository: ppat/homelab-ops-kubernetes-apps

    - name: Checkout pull request branch
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
      with:
        path: pull
        persist-credentials: false

    - name: Checkout default branch
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
      with:
        path: default
        persist-credentials: false
        ref: "${{ github.event.repository.default_branch }}"

    - name: Detect sources
      id: detect-sources
      shell: bash
      working-directory: ./pull
      # yamllint disable-line rule:indentation
      run: |
        echo "Detecting external sources..."
        external_sources=$(grep -rl 'apiVersion: source.toolkit.fluxcd.io' clusters/${{ matrix.cluster }}/ | xargs -n1 yq '.metadata.name' | grep -v '^root' | sort | uniq)
        echo ${external_sources} | tr ' ' '\n' | pr -t -o 4
        echo " "
        echo "Transforming into concatenated source map..."
        ext_src_list=$(for src in ${external_sources}; do echo "${src}=/github/workspace/modules"; done | paste -sd ',' -)
        echo "sources=${ext_src_list}" >> $GITHUB_OUTPUT
        echo ${ext_src_list} | tr ',' '\n' | pr -t -o 4

    - name: Run flux-local diff
      uses: docker://ghcr.io/allenporter/flux-local:v7.5.4@sha256:72dbdeabca1eb4d1a053c78dfa0d1d8e2a4c4aee2c8d3938db1a382d22b0a6f9
      with:
        args: >-
          diff ${{ matrix.resource }}
          --unified 6
          --path /github/workspace/pull/clusters/${{ matrix.cluster }}
          --path-orig /github/workspace/default/clusters/${{ matrix.cluster }}
          --skip-crds
          --skip-secrets
          --strip-attrs "helm.sh/chart,checksum/config,app.kubernetes.io/version,chart"
          --limit-bytes 10000
          --all-namespaces
          --sources "root=./,${{ steps.detect-sources.outputs.sources }}"
          --output-file diff.patch

    - name: Generate Diff
      id: diff
      run: |
        echo 'diff<<EOF' >> $GITHUB_OUTPUT
        cat diff.patch >> $GITHUB_OUTPUT
        echo 'EOF' >> $GITHUB_OUTPUT

    - name: Add PR comment w/ diff
      uses: mshick/add-pr-comment@b8f338c590a895d50bcbfa6c5859251edc8952fc # v2
      if: ${{ steps.diff.outputs.diff != '' }}
      continue-on-error: true
      with:
        repo-token: ${{ secrets.GITHUB_TOKEN }}
        message-id: "${{ github.event.pull_request.number }}/${{ matrix.cluster }}/${{ matrix.resource }}"
        message-failure: Unable to post ${{ matrix.resource }} diff for ${{ matrix.cluster }}
        message: |
          `````diff
          ${{ steps.diff.outputs.diff }}
          `````
